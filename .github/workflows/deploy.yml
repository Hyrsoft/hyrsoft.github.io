name: Sync Public Folder

on:
  push:
    branches:
      - main 

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出当前源代码仓库 (Source Repository)
      # 使用 path 参数将其存放在 'source-code' 目录
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          path: source-code

      # 2. 检出目标仓库 (Target Repository)
      # 使用 path 参数将其存放在 'target-repo' 目录
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: Hyrsoft/hyrsoft.github.io
          # 这里必须使用具有写权限的 Personal Access Token (PAT)
          token: ${{ secrets.DEPLOY_TOKEN }}
          path: target-repo
          # 默认只检出最新的一条记录以提高速度
          fetch-depth: 1

      # 3. 配置 Git 用户信息 (用于提交)
      - name: Set up Git config
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # 4. 同步文件
      # 将源代码仓库中的 public 文件夹内容复制到目标仓库根目录
      - name: Sync public folder
        run: |
          # 确保目标文件夹存在，或者根据需要清空目标仓库中旧的文件
          # rm -rf target-repo/* # 如果你想执行完全同步（删除目标仓库多余文件），取消此行注释
          
          cp -rv source-code/public/* target-repo/

      # 5. 检测变化并提交推送
      - name: Commit and push changes
        run: |
          cd target-repo
          
          # 检查是否有文件变动
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes detected. Skipping commit."
            exit 0
          fi
          
          git add .
          git commit -m "Sync: update content from source repository ($(date +'%Y-%m-%d %H:%M:%S'))"
          
          # 因为 checkout 步骤已经通过 Token 处理了鉴权，这里直接 push 即可
          git push origin main